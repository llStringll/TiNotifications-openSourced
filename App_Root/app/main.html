<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
        <meta charset="utf-8">
        <title>TiNotifications</title>

        <meta name="description" content="Thapar Universitys official event notice platform"/>
        <!-- Manifest -->
        <link rel="manifest" href="manifest.json">

        <!-- Chrome for Android theme color -->
        <meta name="theme-color" content="#3498db">

        <!-- Add to homescreen for Chrome on Android -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="application-name" content="TiNotifications">
        <link rel="icon" sizes="192x192" href="images/profile/logo.png">

        <!-- Add to homescreen for Safari on iOS -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="TiNotifications">
        <link rel="apple-touch-icon" href="images/profile/logo.png">

        <!-- Tile for Win8 -->
        <meta name="msapplication-TileColor" content="#3498db">
        <meta name="msapplication-TileImage" content="images/profile/logo.png">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/homepage.css">
        <link rel="stylesheet" type="text/css" href="css/profile.css">
        <script>
          const userAgent = window.navigator.userAgent.toLowerCase();
           if (/windows/.test( userAgent )){
            alert("Device not compatible, use Android or iOS devices");
            window.location = "/oops.html";
           }
          (function(){
            fetch('/users/chkuser',{
              method:'post'
            }).then(function(resp){
                return resp.text();
            }).then(function(r){
                if(r=='y'){
                }else{
                    window.location="./log_sig.html";
                }
            }).catch(function(err){
                console.error(err);
            });
        })();
        </script>
    </head>
    <body>
        <div class="band2">
          <div class="tohome" id="navig" onclick="changeto('home')"><img src="./img/attachments/HOME FINAL.jpg"></div>
          <div class="tosearch" id="navig" onclick="changeto('search')"><img src="./img/attachments/search final.jpg"></div>
          <!-- <div class="tolinked" id="navig" onclick="changeto('linked')"><img src="./img/attachments/link.jpg"></div> -->
          <div class="toprofile" id="navig" onclick="changeto('profile')"><img src="./img/attachments/Profile final.jpg"></div>
        </div>  
        <div class="band">
          <!-- <p class="logo"><img src="./images/touch/images/main_logo.png"></p> -->
          <span id="banner" style=" padding-left: 10px;">TiNotifications</span>
          <img id="settings" src="./img/gear-settings.png" onclick="show_lgout()">
        </div>      
        <p id="reload_notice" onclick="reld()">
          Tap to get whats new
        </p>
        <span class="popuptext" id="myPopup" onclick="gayab()">Install this app on your iphone:tap [+] below and then Add to homescreen.</span>
        <!-- HOME FEED PAGE -->
        <div class="content" id="home-cont">
          <div id="admin_post">
            <!--ADMIN WILL POST HERE-->
            <textarea id="post" rows="5" cols="40" placeholder="Type a message"></textarea>         
            <input id="upload-input" type="file" name="uploads[]" multiple="multiple">
            <button class="upload-btn" type="button">Attach Files</button>
            <p id="send_post" onclick="postAdmin()">POST IT</p>
            <div id="prog">Uploading...</div>
            <div id="sent">
            </div>
          </div>
          <div id="user_post">
            <center>Your latest feed...</center>
            <div class="content" id="user_post-in">
              <!-- POSTS APPEAR HERE -->
            </div> 
          </div>                      
        </div>

        <!-- SEARCH OTHERS PAGE -->
        <div class="content" id="search-cont">
          <div id="recc">Notice sources...</div>
            <div class="card-soc">
                <h3>Dean of Academic Affairs(DoAA)</h3>
                <p id="socinfo">Notices from DoAA office</p>
            </div>
            <div class="card-soc">
                <h3>Dean of Student Affairs(DoSA)</h3>
                <p id="socinfo">Notices from DoSA office</p>
            </div>
            <div class="card-soc">
                <h3>Dean of Research and Sponsered Projects(DoRSP)</h3>
                <p id="socinfo">Notices from DoRSP office</p>
            </div>            
            <div class="card-soc">
                <h3>Dean of Partnerships & Accreditation(DoRPG)</h3>
                <p id="socinfo">Notices from DoRPG office</p>
            </div>                        
            <div class="card-soc">
                <h3>Center for Industrial Liasion and Placement(CILP)</h3>
                <p id="socinfo">Notices from CILP</p>
            </div>
            <div class="card-soc">
                <h3>Center for Training and Development(CTD)</h3>
                <p id="socinfo">Notices from CTD</p>
            </div>            
            <div class="card-soc">
                <h3>Library</h3>
                <p id="socinfo">Newsletters from library</p>
            </div>
        </div>
        <!-- PROFILE PAGE -->
        <div class="content" id="prof-cont">
          <div class="info-cont">
            <p id="rname"></p>
            <p id="uname"></p>
          </div>
          <!-- <p id="bio"></p> -->
          <hr/>
          <p id="intern-head">Total Subscriptions</p>
          <p id="intern-head2">Notice Sources 7</p>
          <div id="intern-list"><!--Socs pushed here-->
          </div>
          <hr/>
          <div id="panel">
            <p id="logout" onclick="lgout()">Log-out</p>
            <p id="chpwd" onclick="bringboxpwd()">Change password</p>
            <!-- <p id="chbio" onclick="bringboxbio()">Change bio</p> -->
            <a href="https://github.com/llStringll" target="_blank"><p id="creator">About the creator</p></a>
          </div>
        </div>
        <div id="tell-back" onclick="myprompt()"></div>
        <div id="tell">
          <img src="/images/touch/images/noim.png">
          <span id="tell-txt">Add this app to homescreen and allow notifications for staying updated to all the events</span>
        </div>
        <div id="check-back"></div>
        <div id="check"><div class="loading"></div></div>        
        <div id="chpwd-side">
          <div id="login-box">
            <div class="left">
              <img id="vis1" src="img/open-eye.png" onclick="vis1()">
              <input type="password" name="oldpwd" placeholder="Old password" id="oldpwd"/>
              <img id="vis2" src="img/open-eye.png" onclick="vis2()">
              <input type="password" name="newpwd" placeholder="New password" id="newpwd"/>
              <p id="chgpwdmsg">Old password incorrect</p>
              <div id="submit" onclick="chgpwd()">CHANGE</div>
              <div id="closepwd" onclick="closepwd()">CANCEL</div>
            </div>
          </div>
        </div>
<!--         <div id="chbio-side">
          <div id="login-box">
            <div class="left">
              <input type="text" name="newbio" placeholder="Bio" id="newbio"/>
              <div id="submit" onclick="chgbio()">CHANGE</div>
              <div id="closebio" onclick="closebio()">CANCEL</div>
            </div>
          </div>
        </div>  -->       
      <script src="js/main.js"></script>
      <script>        
        function remove(elem){
          for(let i=0;i<elem.length;i++){
            document.getElementById(elem[i]).style.display="none";
          }
        }
        function show(elem){
          for(let i=0;i<elem.length;i++){
            document.getElementById(elem[i]).style.display="block";
          }
        }          
        function gayab(){
          document.getElementById("myPopup").style.visibility="hidden";
        }      
        function myFunction() {
            document.getElementById("myPopup").style.visibility="visible";
        }
        const isIos = () => {
          const userAgent = window.navigator.userAgent.toLowerCase();
          return /iphone|ipad|ipod/.test( userAgent );
        }
        // Detects if device is in standalone mode
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

        // Checks if should display install popup notification:
        if (isIos() && !isInStandaloneMode()) {
          console.log('Install the app');
          myFunction();
        }          
            // Notification.requestPermission();
            subs_check();
            getsoc();
          
          //get all data to customize UI
          $('document').ready(function(){
          fetch('/users/get_user_data', {
            method: 'post'
          }).then(function(resp){
              return resp.json();
          }).then(function(j){
            //j is user data as json object
            get_notifs(j.role);
            document.getElementById('uname').innerHTML = j.email;
            document.getElementById('rname').innerHTML = j.name;
            // document.getElementById('bio').innerHTML = j.bio;
            if(j.role=="user"){
              document.getElementsByClassName("tosearch")[0].style.display="inline-block"
              // document.getElementsByClassName("tolinked")[0].style.display="inline-block";   
              for(let su=0;su<j.subscrips.length;su++){
                if (j.subscrips[su]=="DOAA" || j.subscrips[su]=="DOSA" || j.subscrips[su]=="DORSP" || j.subscrips[su]=="DORPG" || j.subscrips[su]=="LIBRARY" || j.subscrips[su]=="CILP" || j.subscrips[su]=="CTD"){
                  continue;
                }                
                // console.log(j.subscrips[su]);
                document.getElementById('subs-'+j.subscrips[su]).innerHTML = "UNSUBSCRIBE"; 
              }
              document.getElementById("intern-head").innerHTML = "Total Subscriptions  "+String(j.subscrips.length);
              // for(let i=0;i<j.subscrips.length;i++){
              //   if (j.subscrips[i]=="DOAA" || j.subscrips[i]=="DOSA" || j.subscrips[i]=="DORSP" || j.subscrips[i]=="DORPG" || j.subscrips[i]=="LIBRARY" || j.subscrips[i]=="CILP"){
              //     continue;
              //   }
              //   var val = "";
              //   if(j.subscrips[i].includes("HOSTEL")){val = "HOSTEL "+j.subscrips[i].slice(6);}
              //   else {val = j.subscrips[i];}
              //   const item = `<div id="intern"><img src="img/internship.png" />${val}</div>`;
              //   document.getElementById('intern-list').insertAdjacentHTML('afterBegin', item);
              // }
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />CTD</div>`);
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />CILP</div>`);
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />LIBRARY</div>`);
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DORPG</div>`);
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DORSP</div>`);              
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DOAA</div>`);
              document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DOSA</div>`);                                       
            }
            if(j.role=="admin"){
              document.getElementById('rname').innerHTML = j.name.toUpperCase();
              document.getElementById("admin_post").style.display = "block";
              document.getElementById("user_post").style.display = "none";
              document.getElementsByClassName("toprofile")[0].style.float="right";
              document.getElementById("intern-head").innerHTML = "Subscribers  "+String(j.subscrips.length);
              for(let i=0;i<j.subscrips.length;i++){
                var val = "";
                if(j.subscrips[i].includes("HOSTEL"))val = "HOSTEL "+j.subscrips[i].slice(6);
                else val = j.subscrips[i];
                const item = `<div id="intern"><img src="img/internship.png" />${val}</div>`;                
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', item);
              } 
              document.getElementById("intern-head2").style.display="none";               
            }
            else{
             document.getElementById("user_post").style.display = "block";
             document.getElementById("admin_post").style.display = "none"; 
            }
          }).catch(function(err){
            console.log(err);
          });
          });
          function reld(){
            var node = document.getElementById("intern-list");            
            while (node.hasChildNodes()) {
              node.removeChild(node.lastChild);
            }

            var node = document.getElementById("user_post-in");            
            while (node.hasChildNodes()) {
              node.removeChild(node.lastChild);
            }

            var node = document.getElementById("sent");            
            while (node.hasChildNodes()) {
              node.removeChild(node.lastChild);
            }

            
            //get all data to customize UI
            fetch('/users/get_user_data', {
            method: 'post'
            }).then(function(resp){
              return resp.json();
            }).then(function(j){
              //j is user data as json object
              get_notifs(j.role);
              if(j.role=="user"){
                for(let su=0;su<j.subscrips.length;su++){
                if (j.subscrips[su]=="DOAA" || j.subscrips[su]=="DOSA" || j.subscrips[su]=="DORSP" || j.subscrips[su]=="DORPG" || j.subscrips[su]=="LIBRARY" || j.subscrips[su]=="CILP" || j.subscrips[su]=="CTD"){
                  continue;
                }                  
                document.getElementById('subs-'+j.subscrips[su]).innerHTML = "UNSUBSCRIBE"; 
                }
              
              document.getElementById("intern-head").innerHTML = "Total Subscriptions  "+String(j.subscrips.length);

                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />CTD</div>`);
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />CILP</div>`);
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />LIBRARY</div>`);    
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DORPG</div>`);  
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DORSP</div>`);        
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DOAA</div>`);
                document.getElementById('intern-list').insertAdjacentHTML('afterBegin', `<div id="intern"><img src="img/internship.png" />DOSA</div>`);
              }else{
                document.getElementById("intern-head").innerHTML = "Subscribers  "+String(j.subscrips.length);
                for(let i=0;i<j.subscrips.length;i++){
                  var val = "";
                  if(j.subscrips[i].includes("HOSTEL"))val = "HOSTEL "+j.subscrips[i].slice(6);
                  else val = j.subscrips[i];
                  const item = `<div id="intern"><img src="img/internship.png" />${val}</div>`;                
                  document.getElementById('intern-list').insertAdjacentHTML('afterBegin', item);
                }                
              }
            }).catch(function(err){
              console.log(err);
            });
            document.getElementById('reload_notice').style.display="none";                 
          }
          fetch('/users/chkpwd', {
            method:'post',
          }).then(function(resp){
            return resp.text();
          }).then(function(r){
            if(r=="y"){
              alert("Please change your default password for security reasons !");
            }
          }).catch(function(err){
            console.log(err);
          });          
        </script>
        <script>
          var i=0;
          function show_lgout(){
            if (i==0){
              document.getElementById("panel").style.display="block";
              i=1;
            }else{
              document.getElementById("panel").style.display="none";
              i=0;
            }
          }
          window.setTimeout(function(){
              Notification.requestPermission();
              document.getElementById('reload_notice').style.display="block";
          }, 180000);
        </script>
        <script src="/pulltorefresh.js-master/dist/pulltorefresh.js"></script>        
        <script>
          PullToRefresh.init({
            mainElement: 'body',
            triggerElement: 'body',
            onRefresh: function() {
              reld();
            }
          });

          history.replaceState(null, document.title, location.pathname+"#!/easteregg");
          history.pushState(null, document.title, location.pathname);

          window.addEventListener("popstate", function() {
            if(location.hash === "#!/easteregg") {
              history.replaceState(null, document.title, location.pathname);
              setTimeout(function(){
                location.replace("./main.html");
              },0);
            }
          }, false);  
          function bringboxpwd(){
            document.getElementById("chpwd-side").style.display="block";
          }
          function closepwd(){
           document.getElementById("chpwd-side").style.display="none"; 
          }
          // function bringboxbio(){
          //   document.getElementById("chbio-side").style.display="block";
          // }
          // function closebio(){
          //  document.getElementById("chbio-side").style.display="none"; 
          // }          
          function vis1(){
            var x = document.getElementById("oldpwd");
            if (x.type === "password") {
                x.type = "text";
                document.getElementById("vis1").src="img/close-eye.png";
                x.style.marginTop="-2px";
            } else {
                x.type = "password";
                document.getElementById("vis1").src="img/open-eye.png";
            }
          }     
          function vis2(){
            var x = document.getElementById("newpwd");
            if (x.type === "password") {
                x.type = "text";
                document.getElementById("vis2").src="img/close-eye.png";
                x.style.marginTop="-2px";
            } else {
                x.type = "password";
                document.getElementById("vis2").src="img/open-eye.png";
            }
          }       
          function creator(){
            window.location = "https://github.com/llStringll";
          } 

          let installPromptEvent = null;
          let ch=0;
          window.addEventListener('beforeinstallprompt', (event) => {
            // Prevent Chrome <= 67 from automatically showing the prompt
            event.preventDefault();
            // Stash the event so it can be triggered later.
            installPromptEvent = event;
            if(installPromptEvent!=null && ch==0){
              show(['tell-back','tell']);
              ch=1;
            }            
          })
          function myprompt(){
            remove(['tell-back','tell']);
            installPromptEvent.prompt();
            installPromptEvent.userChoice.then((choice) => {
              if (choice.outcome === 'accepted') {
                console.log('User accepted the A2HS prompt');
              } else {
                console.log('User dismissed the A2HS prompt');
              }
              installPromptEvent = null;
            });          
          }
        </script>
    </body>
</html>